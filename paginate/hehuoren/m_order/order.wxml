<navbar parameter="{{ parameter }}"></navbar>
<view class="tab-content-item">
  <!-- 已登录 -->
  <view wx:if="{{isLogin}}" class="goods-detail-box">
    <view class="search-bar">
      <!-- 场地选择器在左 -->
      <picker
              class="address-picker"
              mode="selector"
              range="{{addressList}}"
              range-key="name"
              value="{{addressIndex}}"
              bindchange="onAddressChange"
              bindtap="onAddressTap"
      >
        <view class="picker">
          <text>{{currentAddress ? currentAddress.short_name : '选择场地'}}</text>
        </view>
        <!-- tooltip -->
        <text class="full-name-tip" wx:if="{{showFullName && currentAddress}}">
          {{currentAddress.name}}
        </text>
      </picker>

      <!-- 搜索框在右 -->
      <input
              class="search-input"
              placeholder="请输入手机号"
              value="{{ searchMobile }}"
              bindinput="onSearchInput"
      />
      <button
              type="primary"
              size="mini"
              bindtap="resetList"
              class="search-btn"
              disabled="{{!currentAddress}}"
      >
        搜索
      </button>
    </view>

    <view class="container">
      <view class="copy-tip">
        <text class="iconfont icon-tishi"></text>
        <text>点击卡片 可复制手机号与订单号</text>
      </view>

      <block wx:if="{{orderList.length > 0}}">
        <view class="card-list">
          <view
                  class="card"
                  bindtap="copyOrder"
                  wx:for="{{orderList}}"
                  wx:key="this"
                  data-id="{{item.order_id}}"
                  data-item="{{item}}"
          >
            <view class="card-header">
              <view class="card-title">
                <text class="order-icon">📦</text>
                <view class="title-info">
                  <text class="shop-name">{{item.site_name || '未知设备'}}</text>
                  <text class="order-no">订单号：{{item.pay_code || '暂无'}}</text>
                </view>
              </view>
              <text class="status-tag {{item._statusType}}">{{item.status}}</text>
            </view>

            <view class="info-section">
              <view class="info-row">
                <text class="label">用户名</text>
                <text class="value">{{item.nickname}}</text>
              </view>
              <view class="info-row">
                <text class="label">手机号</text>
                <text class="value highlight">{{item.mobile}}</text>
              </view>
              <view class="info-row">
                <text class="label">IMEI</text>
                <text class="value">{{item.only_code}}</text>
              </view>
              <view class="info-row">
                <text class="label">开始时间</text>
                <text class="value">{{item.begin_time}}</text>
              </view>
              <view class="info-row" wx:if="{{item.status == '已完成'}}">
                <text class="label">支付时间</text>
                <text class="value">{{item.end_time}}</text>
              </view>
            </view>

            <view class="amount-section" wx:if="{{item.status == '已完成'}}">
              <view class="amount-row">
                <text class="label">实际支付</text>
                <text class="value pay">￥{{item.net_amount}}</text>
              </view>
              <block wx:if="{{item.total_amount != item.net_amount}}">
                <view class="amount-row">
                  <text class="label">消费金额</text>
                  <text class="value">￥{{item.total_amount}}</text>
                </view>
                <view class="amount-row">
                  <text class="label">抵扣金额</text>
                  <text class="value discount">-￥{{item.discount_amount}}</text>
                </view>
              </block>
            </view>

            <view class="order-actions" wx:if="{{item.status == '使用中'}}">
              <button class="cancel-btn" catchtap="cancelOrder" data-item="{{item}}">结束订单</button>
            </view>
          </view>
        </view>

        <view wx:if="{{ no_more }}" class="no-more">亲, 没有更多了</view>
      </block>

      <view wx:else class="empty">
        <image src="/images/empty-record.png" class="empty-icon" />
        <text class="empty-text">暂无订单记录</text>
        <text class="empty-subtext">去下第一笔订单吧</text>
      </view>
    </view>
  </view>

  <!-- 未登录 -->
  <view wx:else class="login-tip">
    请先登录
  </view>
</view>
